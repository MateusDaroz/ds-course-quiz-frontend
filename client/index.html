<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz - Desenvolvimento de Sistemas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #020403 20%, #212122);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container-border{
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 600px;
            width: 90%;
            padding: .4rem;
            background: linear-gradient(to right, #663399, #4B0082);
        }

        .container {
            background: #26282A;
            text-align: center;
            border-radius: 20px;
            padding: 2rem;
        }

        h1 {
            color: white;
            margin-bottom: 1.5rem;
            font-size: 2rem;
        }

        h2 {
            color: #cbcbcb;
            margin-bottom: 1.5rem;
        }

        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #4B0082 0%, #663399 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:disabled {
            background: grey;
            cursor: not-allowed;
            transform: none;
        }

        .question-container {
            margin: 20px 0;
        }

        .waiting p{
            color: grey;
        }

        .question {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: bold;
        }

        .alternatives {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .alternative {
            background: #e9ecef;
            border: 3px solid transparent;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .alternative:hover {
            background: #dee2e6;
        }

        .alternative.correct {
            border-color: #28a745;
            background: #d4edda;
        }

        .alternative.wrong {
            border-color: #dc3545;
            background: #f8d7da;
        }

        .alternative.show-correct {
            border-color: #28a745;
            background: #d4edda;
        }

        .player-list {
            text-align: left;
            max-height: 300px;
            overflow-y: auto;
        }

        .player-item {
            background: linear-gradient(135deg, #020403 20%, #212122);
            padding: 10px;
            margin: 5px 0;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-header-list{
            padding: 10px;
            margin: 5px 0;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #4B0082 0%, #663399 100%);
            color: white;
        }

        .player-item span{
            color: white;
        }

        .leaderboard {
            text-align: left;
        }

        .leaderboard-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }

        .leaderboard-item.top {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
        }

        .timer {
            font-size: 24px;
            font-weight: bold;
            color: #dc3545;
            margin: 20px 0;
        }

        .score {
            font-size: 20px;
            font-weight: bold;
            color: #28a745;
            margin: 20px 0;
        }

        .waiting {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .system-selector {
            /*margin-bottom: 2rem;*/
        }

        .system-selector button {
            margin: 0 10px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container-border">
        <div class="container">
            <!-- System Selection -->
            <div id="systemSelector" class="system-selector">
                <h1>Quiz - Desenvolvimento de Sistemas</h1>
                <h2>Teste seus conhecimentos sobre o melhor curso do COTIL!</h2>
                <button onclick="initHost()">Sistema do Organizador</button>
                <button onclick="initPlayer()">Sistema do Jogador</button>
            </div>

            <!-- Player System -->
            <div id="playerSystem" class="hidden">
                <!-- Player Registration -->
                <div id="playerRegistration">
                    <h1>Entre na sala de espera!</h1>
                    <input type="text" id="playerName" placeholder="Digite seu nome" required>
                    <input type="text" id="playerSchool" placeholder="Digite o nome da sua escola" required>
                    <input type="text" id="playerCity" placeholder="Digite o nome da sua cidade" required>
                    <button onclick="joinGame()">Entrar na sala de espera</button>
                </div>

                <!-- Player Waiting -->
                <div id="playerWaiting" class="hidden">
                    <h1>Esperando o jogo começar...</h1>
                    <div class="waiting">
                        <p>Espere todos os jogadores entrarem!</p>
                    </div>
                </div>

                <!-- Player Quiz -->
                <div id="playerQuiz" class="hidden">
                    <div class="score" id="playerScore">Pontuação: 0 pontos</div>
                    <div class="question-container">
                        <div class="question" id="questionText"></div>
                        <div class="alternatives" id="alternatives"></div>
                    </div>
                    <div>Questão <span id="questionNumber">1</span> de 10</div>
                </div>

                <!-- Player Waiting for Results -->
                <div id="playerWaitingResults" class="hidden">
                    <h1>Você completou o quiz!</h1>
                    <div class="score" id="finalScore">Sua pontuação final: 0 pontos</div>
                    <div class="waiting">
                        <p>Esperando todos os jogadores finalizarem...</p>
                    </div>
                </div>

                <!-- Player Final Results -->
                <div id="playerResults" class="hidden">
                    <h1>Resultados Finais</h1>
                    <div class="score" id="playerFinalScore">Sua pontuação: 0 pontos</div>
                    <div class="score" id="playerPosition">Sua posição: #1</div>
                    <div class="leaderboard" id="finalLeaderboard"></div>
                </div>
            </div>

            <!-- Host System -->
            <div id="hostSystem" class="hidden">
                <!-- Host Lobby Setup -->
                <div id="hostLobby">
                    <h1>Quiz - Área do Organizador</h1>
                    <button onclick="openLobby()" id="openLobbyBtn">Abrir sala</button>
                    
                    <div id="lobbyOpen" class="hidden">
                        <h2>Jogadores na Sala:</h2>
                        <div class="player-header-list">
                            <p>Nome</p>
                            <p>Escola - Cidade</p>
                        </div>
                        <div class="player-list" id="playersList"></div>
                        <button onclick="startGame()" id="startGameBtn" disabled>Começar o jogo</button>
                    </div>
                </div>

                <!-- Host Game View -->
                <div id="hostGame" class="hidden">
                    <h1>Classificação Geral</h1>
                    <div class="timer" id="gameTimer">5:00</div>
                    <div class="leaderboard" id="liveLeaderboard"></div>
                </div>

                <!-- Host Final Results -->
                <div id="hostResults" class="hidden">
                    <h1>Resultados do Quiz - Top 3</h1>
                    <div class="leaderboard" id="top3Leaderboard"></div>
                    <button onclick="restartGame()">Reiniciar o jogo</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // WebSocket Connection
        let ws = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        // Game State
        let gameState = {
            isHost: false,
            players: [],
            currentPlayer: null,
            gameStarted: false,
            gameEnded: false,
            currentQuestion: 0,
            gameTimer: 300, // 5 minutes
            roomCode: null,
            questions: [
                {
                    question: "What does HTML stand for?",
                    alternatives: ["Hyper Text Markup Language", "Home Tool Markup Language", "Hyperlinks and Text Markup Language", "Hyper Tool Multi Language"],
                    correct: 0
                },
                {
                    question: "Which CSS property is used to change the text color?",
                    alternatives: ["text-color", "font-color", "color", "text-style"],
                    correct: 2
                },
                {
                    question: "What does CSS stand for?",
                    alternatives: ["Creative Style Sheets", "Cascading Style Sheets", "Computer Style Sheets", "Colorful Style Sheets"],
                    correct: 1
                },
                {
                    question: "Which HTML tag is used to create a hyperlink?",
                    alternatives: ["<link>", "<a>", "<href>", "<url>"],
                    correct: 1
                },
                {
                    question: "What is the correct way to write a JavaScript array?",
                    alternatives: ["var colors = 'red', 'green', 'blue'", "var colors = (1:'red', 2:'green', 3:'blue')", "var colors = ['red', 'green', 'blue']", "var colors = 1 = ('red'), 2 = ('green'), 3 = ('blue')"],
                    correct: 2
                },
                {
                    question: "Which event occurs when the user clicks on an HTML element?",
                    alternatives: ["onchange", "onclick", "onmouseclick", "onmouseover"],
                    correct: 1
                },
                {
                    question: "What does DOM stand for?",
                    alternatives: ["Document Object Model", "Display Object Management", "Dynamic Object Model", "Document Oriented Model"],
                    correct: 0
                },
                {
                    question: "Which method is used to add an element at the end of an array?",
                    alternatives: ["push()", "add()", "append()", "insert()"],
                    correct: 0
                },
                {
                    question: "What is the correct way to write a CSS comment?",
                    alternatives: ["// this is a comment", "/* this is a comment */", "<!-- this is a comment -->", "* this is a comment *"],
                    correct: 1
                },
                {
                    question: "Which HTML attribute specifies an alternate text for an image?",
                    alternatives: ["title", "src", "alt", "longdesc"],
                    correct: 2
                }
            ]
        };

        // WebSocket Functions
        function connectWebSocket() {
            try {
                // Replace with your WebSocket server URL
                ws = new WebSocket('https://loving-generosity-production.up.railway.app');
                
                ws.onopen = function() {
                    console.log('Connected to WebSocket server');
                    reconnectAttempts = 0;
                    updateConnectionStatus('Connected');
                };

                ws.onmessage = function(event) {
                    const message = JSON.parse(event.data);
                    handleWebSocketMessage(message);
                };

                ws.onclose = function() {
                    console.log('Disconnected from WebSocket server');
                    updateConnectionStatus('Disconnected - Attempting to reconnect...');
                    attemptReconnect();
                };

                ws.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    updateConnectionStatus('Connection Error');
                };
            } catch (error) {
                console.error('Failed to connect to WebSocket:', error);
                updateConnectionStatus('Failed to Connect - Using Local Mode');
                // Fall back to local mode
            }
        }

        function attemptReconnect() {
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                setTimeout(() => {
                    console.log(`Reconnection attempt ${reconnectAttempts}`);
                    connectWebSocket();
                }, 2000 * reconnectAttempts);
            } else {
                updateConnectionStatus('Connection Failed - Using Local Mode');
            }
        }

        function updateConnectionStatus(status) {
            // You can add a status indicator to the UI if needed
            console.log('Connection status:', status);
        }

        function sendWebSocketMessage(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
            } else {
                console.warn('WebSocket not connected, message not sent:', message);
                // Handle offline mode or queue messages
            }
        }

        function handleWebSocketMessage(message) {
            switch (message.type) {
                case 'room_created':
                    gameState.roomCode = message.roomCode;
                    updateRoomCode();
                    break;
                
                case 'player_joined':
                    if (gameState.isHost) {
                        gameState.players = message.players;
                        updateHostPlayersList();
                    }
                    break;
                
                case 'game_started':
                    if (!gameState.isHost) {
                        startPlayerQuiz();
                    }
                    break;
                
                case 'leaderboard_update':
                    if (gameState.isHost) {
                        gameState.players = message.players;
                        updateHostLeaderboard();
                    }
                    break;
                
                case 'game_ended':
                    endGameFromServer(message.finalResults);
                    break;
                
                case 'timer_update':
                    if (gameState.isHost) {
                        gameState.gameTimer = message.timeLeft;
                        updateTimerDisplay();
                    }
                    break;
                
                case 'error':
                    alert(message.message);
                    break;
            }
        }

        // Initialize WebSocket connection on page load
        window.addEventListener('load', function() {
            connectWebSocket();
        });

        // System Initialization
        function initHost() {
            gameState.isHost = true;
            document.getElementById('systemSelector').classList.add('hidden');
            document.getElementById('hostSystem').classList.remove('hidden');
            
            // Request room creation from server
            sendWebSocketMessage({
                type: 'create_room'
            });
        }

        function initPlayer() {
            gameState.isHost = false;
            document.getElementById('systemSelector').classList.add('hidden');
            document.getElementById('playerSystem').classList.remove('hidden');
        }

        // Player Functions
        function joinGame() {
            const name = document.getElementById('playerName').value.trim();
            const school = document.getElementById('playerSchool').value.trim();
            const city = document.getElementById('playerCity').value.trim();

            if (!name || !school || !city) {
                alert('Por favor, preencha todos os campos!');
                return;
            }

            gameState.currentPlayer = {
                id: Date.now(),
                name: name,
                school: school,
                city: city,
                score: 0,
                answeredQuestions: 0,
                finished: false
            };

            // Send join request to server
            sendWebSocketMessage({
                type: 'join_game',
                player: gameState.currentPlayer,
                roomCode: gameState.roomCode
            });

            document.getElementById('playerRegistration').classList.add('hidden');
            document.getElementById('playerWaiting').classList.remove('hidden');
        }

        function startPlayerQuiz() {
            document.getElementById('playerWaiting').classList.add('hidden');
            document.getElementById('playerQuiz').classList.remove('hidden');
            showQuestion();
        }

        function showQuestion() {
            if (gameState.currentQuestion >= gameState.questions.length) {
                finishPlayerQuiz();
                return;
            }

            const question = gameState.questions[gameState.currentQuestion];
            document.getElementById('questionText').textContent = question.question;
            document.getElementById('questionNumber').textContent = gameState.currentQuestion + 1;

            const alternativesContainer = document.getElementById('alternatives');
            alternativesContainer.innerHTML = '';

            question.alternatives.forEach((alt, index) => {
                const altDiv = document.createElement('div');
                altDiv.className = 'alternative';
                altDiv.textContent = alt;
                altDiv.onclick = () => selectAnswer(index);
                alternativesContainer.appendChild(altDiv);
            });
        }

        function selectAnswer(selectedIndex) {
            const question = gameState.questions[gameState.currentQuestion];
            const alternatives = document.querySelectorAll('.alternative');
            
            // Disable all alternatives
            alternatives.forEach(alt => alt.onclick = null);

            const isCorrect = selectedIndex === question.correct;
            
            if (isCorrect) {
                alternatives[selectedIndex].classList.add('correct');
                gameState.currentPlayer.score += 10;
                updatePlayerScore();
            } else {
                alternatives[selectedIndex].classList.add('wrong');
                alternatives[question.correct].classList.add('show-correct');
            }

            gameState.currentPlayer.answeredQuestions++;
            gameState.currentQuestion++;

            // Send answer to server
            sendWebSocketMessage({
                type: 'answer_submitted',
                playerId: gameState.currentPlayer.id,
                questionIndex: gameState.currentQuestion - 1,
                selectedAnswer: selectedIndex,
                isCorrect: isCorrect,
                newScore: gameState.currentPlayer.score
            });

            setTimeout(() => {
                showQuestion();
            }, 2000);
        }

        function updatePlayerScore() {
            document.getElementById('playerScore').textContent = `Pontuação: ${gameState.currentPlayer.score} pontos`;
        }

        function finishPlayerQuiz() {
            gameState.currentPlayer.finished = true;
            document.getElementById('playerQuiz').classList.add('hidden');
            document.getElementById('playerWaitingResults').classList.remove('hidden');
            document.getElementById('finalScore').textContent = `Sua pontuação final: ${gameState.currentPlayer.score} pontos`;

            // Notify server that player finished
            sendWebSocketMessage({
                type: 'player_finished',
                playerId: gameState.currentPlayer.id,
                finalScore: gameState.currentPlayer.score
            });
        }

        // Host Functions
        function openLobby() {
            document.getElementById('openLobbyBtn').classList.add('hidden');
            document.getElementById('lobbyOpen').classList.remove('hidden');
            updateHostPlayersList();
        }

        function updateHostPlayersList() {
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = '';

            gameState.players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-item';
                playerDiv.innerHTML = `<span>${player.name}</span><span>${player.school} - ${player.city}</span>`;
                playersList.appendChild(playerDiv);
            });

            const startBtn = document.getElementById('startGameBtn');
            startBtn.disabled = gameState.players.length === 0;
        }

        function startGame() {
            gameState.gameStarted = true;
            document.getElementById('hostLobby').classList.add('hidden');
            document.getElementById('hostGame').classList.remove('hidden');

            // Send start game message to server
            sendWebSocketMessage({
                type: 'start_game'
            });

            updateHostLeaderboard();
        }

        function updateTimerDisplay() {
            const timerElement = document.getElementById('gameTimer');
            const minutes = Math.floor(gameState.gameTimer / 60);
            const seconds = gameState.gameTimer % 60;
            timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateHostLeaderboard() {
            const leaderboard = document.getElementById('liveLeaderboard');
            const sortedPlayers = [...gameState.players].sort((a, b) => b.score - a.score);
            
            leaderboard.innerHTML = '';
            sortedPlayers.forEach((player, index) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'leaderboard-item';
                playerDiv.innerHTML = `
                    <span>#${index + 1} ${player.name}</span>
                    <span>${player.score} points</span>
                `;
                leaderboard.appendChild(playerDiv);
            });
        }

        function checkAllPlayersFinished() {
            const allFinished = gameState.players.every(player => player.finished);
            if (allFinished) {
                setTimeout(() => {
                    endGame();
                }, 2000);
            }
        }

        function endGameFromServer(finalResults) {
            gameState.gameEnded = true;
            gameState.players = finalResults.players;
            
            // Show host results
            if (gameState.isHost) {
                showHostResults();
            }
            
            // Show player results
            showPlayerResults();
        }

        function endGame() {
            gameState.gameEnded = true;
            
            // Show host results
            if (gameState.isHost || document.getElementById('hostGame').classList.contains('hidden') === false) {
                showHostResults();
            }
            
            // Show player results
            showPlayerResults();
        }

        function showHostResults() {
            document.getElementById('hostGame').classList.add('hidden');
            document.getElementById('hostResults').classList.remove('hidden');
            
            const top3Players = [...gameState.players]
                .sort((a, b) => b.score - a.score)
                .slice(0, 3);
            
            const top3Leaderboard = document.getElementById('top3Leaderboard');
            top3Leaderboard.innerHTML = '';
            
            top3Players.forEach((player, index) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = `leaderboard-item ${index === 0 ? 'top' : ''}`;
                playerDiv.innerHTML = `
                    <span>#${index + 1} ${player.name}</span>
                    <span>${player.score} pontos</span>
                `;
                top3Leaderboard.appendChild(playerDiv);
            });
        }

        function showPlayerResults() {
            if (gameState.currentPlayer) {
                document.getElementById('playerWaitingResults').classList.add('hidden');
                document.getElementById('playerResults').classList.remove('hidden');
                
                const sortedPlayers = [...gameState.players].sort((a, b) => b.score - a.score);
                const playerPosition = sortedPlayers.findIndex(p => p.id === gameState.currentPlayer.id) + 1;
                
                document.getElementById('playerFinalScore').textContent = `Sua pontuação: ${gameState.currentPlayer.score} pontos`;
                document.getElementById('playerPosition').textContent = `Sua posição: #${playerPosition}`;
                
                const finalLeaderboard = document.getElementById('finalLeaderboard');
                finalLeaderboard.innerHTML = '';
                
                sortedPlayers.forEach((player, index) => {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = `leaderboard-item ${player.id === gameState.currentPlayer.id ? 'top' : ''}`;
                    playerDiv.innerHTML = `
                        <span>#${index + 1} ${player.name}</span>
                        <span>${player.score} pontos</span>
                    `;
                    finalLeaderboard.appendChild(playerDiv);
                });
            }
        }

        function restartGame() {
            // Send restart message to server
            sendWebSocketMessage({
                type: 'restart_game'
            });

            // Reset local game state
            gameState.players = [];
            gameState.currentPlayer = null;
            gameState.gameStarted = false;
            gameState.gameEnded = false;
            gameState.currentQuestion = 0;
            gameState.gameTimer = 300;
            
            // Reset UI
            document.getElementById('hostResults').classList.add('hidden');
            document.getElementById('hostLobby').classList.remove('hidden');
            document.getElementById('openLobbyBtn').classList.remove('hidden');
            document.getElementById('lobbyOpen').classList.add('hidden');
            
            // Reset player UI
            document.getElementById('playerResults').classList.add('hidden');
            document.getElementById('playerRegistration').classList.remove('hidden');
            document.getElementById('playerName').value = '';
            document.getElementById('playerSchool').value = '';
            document.getElementById('playerCity').value = '';
        }

        function updateRoomCode() {
            // Add room code display to host UI if needed
            console.log('Room code:', gameState.roomCode);
        }

        // Fallback functions for offline mode
        function endGame() {
            gameState.gameEnded = true;
            
            // Show host results
            if (gameState.isHost) {
                showHostResults();
            }
            
            // Show player results
            showPlayerResults();
        }

        // Remove demo players function as it's not needed with WebSocket
    </script>
</body>
</html>